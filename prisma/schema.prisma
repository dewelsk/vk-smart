// prisma/schema.prisma

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ==================== USERS & AUTH ====================

enum UserRole {
  SUPERADMIN  // Správca celého systému, spravuje rezorty a adminov
  ADMIN       // Správca rezortu, vytvára VK
  GESTOR      // Spravuje konkrétne VK
  KOMISIA     // Hodnotí uchádzačov
}

// ==================== USER ROLES ====================

// M:N join table pre User <-> Role
model UserRoleAssignment {
  id            String   @id @default(cuid())

  userId        String
  user          User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  role          UserRole

  assignedAt    DateTime @default(now())
  assignedBy    String?  // ID užívateľa, ktorý pridelil rolu

  @@unique([userId, role])
  @@map("user_role_assignments")
}

// User model - Trvalé účty (Superadmin, Admin, Gestor, Komisia)
model User {
  id            String   @id @default(cuid())
  username      String   @unique
  email         String?  @unique
  password      String?
  name          String
  surname       String
  phone         String?
  role          UserRole
  note          String?

  otpSecret     String?
  otpEnabled    Boolean  @default(false)
  recoveryCode  String?

  passwordSetToken       String?   @unique
  passwordSetTokenExpiry DateTime?

  // 2FA Management
  twoFactorRequired      Boolean   @default(false)
  twoFactorBackupCodes   String[]  @default([])
  twoFactorLastUsedAt    DateTime?

  // Password Management
  mustChangePassword     Boolean   @default(false)
  passwordChangedAt      DateTime?
  passwordResetToken     String?   @unique
  passwordResetExpiry    DateTime?

  // Account Security
  failedLoginAttempts    Int       @default(0)
  lockedUntil            DateTime?
  lockReason             String?

  deleted       Boolean  @default(false)
  deletedAt     DateTime?
  deletedEmail  String?

  active        Boolean  @default(true)
  temporaryAccount Boolean @default(false)
  archivedAt    DateTime?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  lastLoginAt   DateTime?

  userRoles     UserRoleAssignment[]
  createdVKs    VyberoveKonanie[]  @relation("CreatedBy")
  gestorVKs     VyberoveKonanie[]  @relation("GestorVK")
  commissionMemberships CommissionMember[]
  evaluations   Evaluation[]
  auditLogs     AuditLog[]
  testResults   TestResult[]
  practiceTestResults PracticeTestResult[]
  securitySettingsUpdates SecuritySettings[] @relation("SecuritySettingsUpdatedBy")
  assignedTests TestAssignment[] @relation("AssignedTests")
  createdAssignments TestAssignment[] @relation("CreatedAssignments")
  sessions      UserSession[]
  breakGlassRequests BreakGlassAccess[] @relation("BreakGlassRequested")
  breakGlassApprovals1 BreakGlassAccess[] @relation("BreakGlassApprover1")
  breakGlassApprovals2 BreakGlassAccess[] @relation("BreakGlassApprover2")

  @@map("users")
}

// ==================== VÝBEROVÉ KONANIA ====================

model VyberoveKonanie {
  id                String   @id @default(cuid())
  identifier        String   @unique

  selectionType     String
  organizationalUnit String
  serviceField      String
  position          String
  serviceType       String
  startDateTime     DateTime

  numberOfPositions Int      @default(1)

  status            VKStatus @default(PRIPRAVA)

  gestorId          String?
  gestor            User?    @relation("GestorVK", fields: [gestorId], references: [id])

  createdById       String
  createdBy         User     @relation("CreatedBy", fields: [createdById], references: [id])
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  candidates        Candidate[]
  assignedTests     VKTest[]
  attachments       CandidateAttachment[]
  commission        Commission?
  evaluationConfig  EvaluationConfig?
  documents         GeneratedDocument[]

  @@map("vyberove_konania")
}

enum VKStatus {
  PRIPRAVA
  CAKA_NA_TESTY
  TESTOVANIE
  HODNOTENIE
  DOKONCENE
  ZRUSENE
}

// ==================== TESTY ====================

model Test {
  id                   String               @id @default(cuid())
  name                 String
  testTypeId           String               @map("type")
  testType             TestType             @relation(fields: [testTypeId], references: [id])
  testTypeConditionId  String?
  testTypeCondition    TestTypeCondition?   @relation(fields: [testTypeConditionId], references: [id])
  description          String?

  questions            Json

  // Allowed question types for this test (must be subset of institution's allowed types)
  allowedQuestionTypes Json? @default("[\"SINGLE_CHOICE\"]")

  recommendedQuestionCount Int?
  recommendedDuration      Int?
  recommendedScore         Float?
  difficulty               Int?    @default(5)  // 1-10, kde 1 = najľahší, 10 = najnáročnejší

  approved             Boolean  @default(false)
  approvedAt           DateTime?

  practiceEnabled      Boolean  @default(false)

  authorId             String?

  categoryId           String?
  category             TestCategory? @relation(fields: [categoryId], references: [id])

  // Generated search column for diacritic-insensitive search
  name_search          String?  @map("name_search")

  createdAt            DateTime @default(now())
  updatedAt            DateTime @updatedAt

  vkAssignments        VKTest[]
  testSessions         TestSession[]
  results              TestResult[]
  practiceResults      PracticeTestResult[]
  assignment           TestAssignment?

  @@index([testTypeId])
  @@index([testTypeConditionId])
  @@map("tests")
}

model TestType {
  id          String   @id @default(cuid())
  name        String   @unique
  description String?

  categories  TestCategory[]
  conditions  TestTypeCondition[]
  tests       Test[]
  assignments TestAssignment[]

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@map("test_types")
}

model TestTypeCondition {
  id          String   @id @default(cuid())
  testTypeId  String
  name        String
  description String?
  sortOrder   Int      @default(0)

  // Zakonné pravidlá testovania
  minQuestions      Int?    // minimum počet otázok
  maxQuestions      Int?    // maximum počet otázok
  timeLimitMinutes  Int?    // časový limit v minútach
  pointsPerQuestion Float?  // body za správnu odpoveď
  minimumScore      Int?    // minimum bodov na úspech

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  testType    TestType @relation(fields: [testTypeId], references: [id], onDelete: Cascade)
  tests       Test[]
  assignments TestAssignment[]

  @@map("test_type_conditions")
  @@index([testTypeId, sortOrder])
}

model TestCategory {
  id          String   @id @default(cuid())
  name        String   @unique

  typeId      String?
  type        TestType? @relation(fields: [typeId], references: [id])

  description String?

  tests       Test[]

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@map("test_categories")
}

model VKTest {
  id            String   @id @default(cuid())

  vkId          String
  vk            VyberoveKonanie @relation(fields: [vkId], references: [id], onDelete: Cascade)

  testId        String
  test          Test     @relation(fields: [testId], references: [id])

  level         Int  // Sequence order (1, 2, 3, ...) not test type

  // Test configuration (overrides from Test model)
  questionCount    Int?
  durationMinutes  Int?
  minScore         Int?

  createdAt     DateTime @default(now())

  testSessions  TestSession[]

  @@unique([vkId, level])  // Keep unique level for ordering
  @@map("vk_tests")
}

// ==================== KANDIDÁTI ====================

model Candidate {
  id                String   @id @default(cuid())

  // Auth
  cisIdentifier     String   @unique  // CIS ID = login username
  password          String?            // Hashed PIN

  // Personal info
  name              String
  surname           String
  email             String?
  birthDate         DateTime?
  phone             String?

  // VK relation
  vkId              String
  vk                VyberoveKonanie @relation(fields: [vkId], references: [id], onDelete: Cascade)

  // Flags
  active            Boolean  @default(true)
  isArchived        Boolean  @default(false)
  deleted           Boolean  @default(false)
  deletedAt         DateTime?
  deletedEmail      String?

  // Timestamps
  registeredAt      DateTime @default(now())
  lastLoginAt       DateTime?
  updatedAt         DateTime @updatedAt

  // Relations
  testSessions      TestSession[]
  testResults       TestResult[]
  documents         Document[]
  evaluations       Evaluation[]
  attachments       CandidateAttachment[]

  @@map("candidates")
}

// ==================== VÝSLEDKY TESTOV ====================

// TestSession - Aktívne testovacie sessions pre uchádzačov
model TestSession {
  id              String   @id @default(cuid())

  candidateId     String
  candidate       Candidate @relation(fields: [candidateId], references: [id], onDelete: Cascade)

  vkTestId        String
  vkTest          VKTest @relation(fields: [vkTestId], references: [id], onDelete: Cascade)

  testId          String
  test            Test @relation(fields: [testId], references: [id])

  status          SessionStatus @default(NOT_STARTED)

  answers         Json @default("{}")

  startedAt       DateTime?
  lastAccessedAt  DateTime?
  completedAt     DateTime?

  serverStartTime DateTime?
  durationSeconds Int?

  score           Float?
  maxScore        Float?
  passed          Boolean?

  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@unique([candidateId, vkTestId])
  @@map("test_sessions")
}

enum SessionStatus {
  NOT_STARTED
  IN_PROGRESS
  PAUSED
  COMPLETED
  TIME_EXPIRED
}

model TestResult {
  id            String   @id @default(cuid())

  candidateId   String
  candidate     Candidate @relation(fields: [candidateId], references: [id], onDelete: Cascade)

  testId        String
  test          Test     @relation(fields: [testId], references: [id])

  userId        String
  user          User     @relation(fields: [userId], references: [id])

  answers       Json
  score         Float
  maxScore      Float
  successRate   Float
  passed        Boolean

  startedAt     DateTime
  completedAt   DateTime?
  durationSeconds Int?

  createdAt     DateTime @default(now())

  @@unique([candidateId, testId])
  @@map("test_results")
}

// Practice Test Results - oddelené od reálnych výsledkov kandidátov
model PracticeTestResult {
  id            String   @id @default(cuid())

  testId        String
  test          Test     @relation(fields: [testId], references: [id])

  userId        String
  user          User     @relation(fields: [userId], references: [id])

  answers       Json
  score         Float
  maxScore      Float
  successRate   Float
  passed        Boolean

  startedAt     DateTime
  completedAt   DateTime?
  durationSeconds Int?

  createdAt     DateTime @default(now())

  @@map("practice_test_results")
}

// ==================== KOMISIA ====================

model Commission {
  id            String   @id @default(cuid())

  vkId          String   @unique
  vk            VyberoveKonanie @relation(fields: [vkId], references: [id], onDelete: Cascade)

  chairmanId    String?

  createdAt     DateTime @default(now())

  members       CommissionMember[]

  @@map("commissions")
}

model CommissionMember {
  id            String   @id @default(cuid())

  commissionId  String
  commission    Commission @relation(fields: [commissionId], references: [id], onDelete: Cascade)

  userId        String
  user          User     @relation(fields: [userId], references: [id])

  isChairman    Boolean  @default(false)

  createdAt     DateTime @default(now())

  evaluations   Evaluation[]

  @@unique([commissionId, userId])
  @@map("commission_members")
}

// ==================== HODNOTENIE ====================

model EvaluationConfig {
  id            String   @id @default(cuid())

  vkId          String   @unique
  vk            VyberoveKonanie @relation(fields: [vkId], references: [id], onDelete: Cascade)

  evaluatedTraits String[]

  questionBattery Json

  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  @@map("evaluation_configs")
}

model Evaluation {
  id            String   @id @default(cuid())

  candidateId   String
  candidate     Candidate @relation(fields: [candidateId], references: [id], onDelete: Cascade)

  memberId      String
  member        CommissionMember @relation(fields: [memberId], references: [id])

  userId        String
  user          User     @relation(fields: [userId], references: [id])

  evaluation    Json

  totalScore    Float
  maxScore      Float
  successRate   Float

  finalized     Boolean  @default(false)
  finalizedAt   DateTime?

  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  @@unique([candidateId, memberId])
  @@map("evaluations")
}

// ==================== DOKUMENTY ====================

model Document {
  id            String   @id @default(cuid())

  candidateId   String
  candidate     Candidate @relation(fields: [candidateId], references: [id], onDelete: Cascade)

  type          DocTyp
  name          String
  path          String

  uploadedAt    DateTime @default(now())

  @@map("documents")
}

enum DocTyp {
  CV
  MOTIVACNY_LIST
  CERTIFIKAT
  INE
}

enum CandidateAttachmentType {
  CV
  MOTIVATION
  CERTIFICATE
  OTHER
  UNKNOWN
}

model CandidateAttachment {
  id               String   @id @default(cuid())

  candidateId      String
  candidate        Candidate @relation(fields: [candidateId], references: [id], onDelete: Cascade)

  vkId             String
  vk               VyberoveKonanie @relation(fields: [vkId], references: [id], onDelete: Cascade)

  documentType     CandidateAttachmentType
  originalFileName String
  storedFileName   String
  storagePath      String
  mimeType         String?
  fileSize         Int

  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  @@index([candidateId, vkId], map: "idx_candidate_attachment_candidate_vk")
  @@map("candidate_attachments")
}

model SecuritySettings {
  id                   String   @id @default(cuid())
  maxFailedAttempts    Int      @default(5)
  blockDurationMinutes Int      @default(15)
  blockWindowMinutes   Int      @default(15)
  updatedById          String?
  updatedBy            User?    @relation("SecuritySettingsUpdatedBy", fields: [updatedById], references: [id])
  createdAt            DateTime @default(now())
  updatedAt            DateTime @updatedAt

  @@map("security_settings")
}

model QuestionCategory {
  id          String          @id @default(cuid())
  name        String          @unique
  description String
  sortOrder   Int             @default(0)
  createdAt   DateTime        @default(now())
  updatedAt   DateTime        @updatedAt

  questions   QuestionItem[]

  @@map("question_categories")
}

model QuestionItem {
  id          String   @id @default(cuid())
  categoryId  String
  text        String
  sortOrder   Int      @default(0)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  category    QuestionCategory @relation(fields: [categoryId], references: [id], onDelete: Cascade)

  @@map("question_items")
  @@index([categoryId, sortOrder])
}

model GeneratedDocument {
  id            String   @id @default(cuid())

  vkId          String
  vk            VyberoveKonanie @relation(fields: [vkId], references: [id], onDelete: Cascade)

  type          GenDocTyp
  path          String

  generatedAt   DateTime @default(now())

  @@map("generated_documents")
}

enum GenDocTyp {
  SUMARNY_HAROK
  ZAVERECNE_HODNOTENIE
  ZAPISNICA
}

// ==================== AUDIT LOG (Rozšírený) ====================

model AuditLog {
  id            String   @id @default(cuid())

  userId        String?
  user          User?    @relation(fields: [userId], references: [id], onDelete: SetNull)

  action        String
  entity        String?
  entityId      String?

  details       Json?
  previousValue Json?
  newValue      Json?

  ipAddress     String?
  userAgent     String?
  sessionId     String?
  requestId     String?

  severity      LogSeverity @default(INFO)

  timestamp     DateTime @default(now())

  @@index([userId])
  @@index([action])
  @@index([entity])
  @@index([sessionId])
  @@index([timestamp])
  @@index([severity])
  @@map("audit_logs")
}

enum LogSeverity {
  CRITICAL
  WARNING
  INFO
}

enum AssignmentStatus {
  PENDING        // Gestor ešte nezačal
  IN_PROGRESS    // Gestor rozpracoval
  COMPLETED      // Gestor dokončil (čaká na schválenie)
  APPROVED       // Admin schválil
}

// ==================== TEST ASSIGNMENTS ====================

model TestAssignment {
  id                  String   @id @default(cuid())

  // Kto má vytvoriť test
  assignedToUserId    String
  assignedToUser      User     @relation("AssignedTests", fields: [assignedToUserId], references: [id])

  // Admin ktorý priradil
  createdById         String
  createdBy           User     @relation("CreatedAssignments", fields: [createdById], references: [id])

  // Aký test sa má vytvoriť
  testTypeId          String
  testType            TestType @relation(fields: [testTypeId], references: [id])

  testTypeConditionId String
  testTypeCondition   TestTypeCondition @relation(fields: [testTypeConditionId], references: [id])

  // Popis úlohy
  name                String
  description         String?

  // Status
  status              AssignmentStatus @default(PENDING)

  // Výsledok (keď gestor dokončí)
  testId              String?  @unique
  test                Test?    @relation(fields: [testId], references: [id])

  createdAt           DateTime @default(now())
  startedAt           DateTime?
  completedAt         DateTime?
  approvedAt          DateTime?
  approvedById        String?

  @@map("test_assignments")
}

// ==================== USER SESSIONS ====================

model UserSession {
  id            String   @id @default(cuid())
  
  userId        String
  user          User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  sessionToken  String   @unique
  ipAddress     String?
  userAgent     String?
  deviceInfo    String?
  
  createdAt     DateTime @default(now())
  lastAccessedAt DateTime @default(now())
  expiresAt     DateTime
  
  active        Boolean  @default(true)
  
  @@index([userId, active])
  @@index([sessionToken])
  @@map("user_sessions")
}

// ==================== BREAK-GLASS ACCESS ====================

model BreakGlassAccess {
  id                String   @id @default(cuid())
  
  requestedById     String
  requestedBy       User     @relation("BreakGlassRequested", fields: [requestedById], references: [id])
  
  approvedById1     String?
  approvedBy1       User?    @relation("BreakGlassApprover1", fields: [approvedById1], references: [id])
  
  approvedById2     String?
  approvedBy2       User?    @relation("BreakGlassApprover2", fields: [approvedById2], references: [id])
  
  reason            String
  status            BreakGlassStatus @default(PENDING)
  
  accessGrantedAt   DateTime?
  accessRevokedAt   DateTime?
  expiresAt         DateTime
  
  createdAt         DateTime @default(now())
  
  @@map("break_glass_access")
}

enum BreakGlassStatus {
  PENDING
  APPROVED
  DENIED
  EXPIRED
  REVOKED
}
