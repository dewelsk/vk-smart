# Denný report - 11. október 2025

## Dokončené úlohy

### 1. Oprava admin switch na uchádzača - 404 error pri testoch

**Problém:** Po prepnutí admina na uchádzača sa zobrazovala 404 chyba pri otváraní testov na URL `/applicant/test/[sessionId]`

**Root cause:** 
- Súbory boli v `app/(applicant)/test/[sessionId]/page.tsx`
- Next.js 14 route groups `(applicant)` sa NEzobrazujú v URL
- Vytvorená URL: `/test/[sessionId]`
- Potrebná URL: `/applicant/test/[sessionId]`

**Riešenie:**
- Presunuli súbory z `app/(applicant)/` na `app/applicant/` (odstránenie route group)
- Vytvorili `app/applicant/layout.tsx`
- Reštruktúrované súbory:
  - `app/applicant/test/[sessionId]/page.tsx`
  - `app/applicant/test/[sessionId]/result/page.tsx`
  - `app/applicant/my-tests/page.tsx`
  - `app/applicant/login/page.tsx`
  - `app/applicant/dashboard/page.tsx`

**Súbory:** `app/applicant/**`

---

### 2. JWT token autentifikácia pre applicant routes

**Problém:** Admin switch používa JWT token v cookie, ale API routes očakávali `x-candidate-id` header

**Riešenie:**
1. Vytvorili nový endpoint `/api/applicant/session` - získava candidate data z JWT tokenu
2. Aktualizovali všetky applicant API routes s dual authentication:
   - Primárne: JWT token (pre admin switch)
   - Fallback: `x-candidate-id` header (pre regular login)
3. Aktualizovali frontend pages aby používali session API s fallback na sessionStorage

**Implementovaný pattern v každom API route:**
```typescript
async function getCandidateFromRequest(request: NextRequest) {
  // Try JWT token first (for admin switch)
  const token = await getToken({
    req: request,
    secret: process.env.AUTH_SECRET || process.env.NEXTAUTH_SECRET,
  })

  if (token?.candidateId) {
    return await prisma.candidate.findUnique({
      where: { id: token.candidateId as string }
    })
  }

  // Fallback to header (for regular applicant login)
  const candidateId = request.headers.get('x-candidate-id')
  if (!candidateId) return null

  return await prisma.candidate.findUnique({
    where: { id: candidateId }
  })
}
```

**Aktualizované súbory:**
- `app/api/applicant/session/route.ts` (nový)
- `app/api/applicant/test/start/route.ts`
- `app/api/applicant/test/[sessionId]/route.ts`
- `app/api/applicant/test/[sessionId]/save/route.ts`
- `app/api/applicant/test/[sessionId]/submit/route.ts`
- `app/(applicant)/test/[sessionId]/page.tsx`
- `app/(applicant)/my-tests/page.tsx`

---

### 3. Oprava admin switch banner

**Problém:** Banner sa nezobrazoval po prepnutí admina na uchádzača

**Root cause:** `SwitchedUserBannerWrapper` používal `session.user.username`, ale pri `token.type === 'candidate'` nie je username nastavený

**Riešenie:**
1. Aktualizovali `auth.ts` session callback - propaguje `originalUsername` z tokenu
2. Aktualizovali `SwitchedUserBannerWrapper.tsx` - používa `originalUsername` namiesto `username`
3. Pridali `originalUsername` do TypeScript definícií

**Súbory:**
- `auth.ts:203`
- `components/SwitchedUserBannerWrapper.tsx:15`
- `types/next-auth.d.ts:42`

---

### 4. Deaktivácia security checks (MVP mode)

**Zmena:** Dočasne deaktivované všetky security checks v applicant API routes per user requirement "Je to MVP"

**Deaktivované kontroly:**
- Overenie že test patrí k VK uchádzača
- Overenie že VK je v stave TESTOVANIE
- Overenie že predošlý level bol úspešne dokončený
- Overenie ownership test session
- Prevencia opätovného spustenia dokončeného testu

**Poznámka:** Všetky security checks sú označené s `// MVP:` a `// TODO: Re-enable in production`

**Súbory:**
- `app/api/applicant/test/start/route.ts:64-132`
- `app/api/applicant/test/[sessionId]/route.ts:81-102`
- `app/api/applicant/test/[sessionId]/save/route.ts:114-132`

---

### 5. Oprava dashboard page layout

**Problém:** Dashboard page zobrazoval obsah na celú šírku obrazovky

**Riešenie:**
1. Pridali wrapper s `max-w-5xl mx-auto px-4 py-8` - centruje obsah s max šírkou
2. Opravili syntax error spôsobený zlou indentáciou pomocou Prettier

**Súbor:** `app/applicant/dashboard/page.tsx:372-439`

---

### 6. Oprava banneru "Návrat naspäť" pri testoch

**Problém:** Banner sa vizuálne skrýval pri otvorení testov - zobrazoval sa za sticky headerom test page.

**Root cause:**
- Test page mal sticky header s `top-0 z-10`
- Banner má `fixed top-0 z-50`
- Oba elementy súťažili o rovnakú `top-0` pozíciu
- Sticky header prekrýval fixed banner (aj napriek vyššiemu z-index)

**Riešenie:**
1. Pridané `pt-16` (padding-top 64px) pre všetky applicant pages
2. Zmenené `top-0` na `top-16` pre sticky header na test page
3. Zabezpečené, že banner má vždy priestor 64px zhora

**Upravené súbory:**
- `app/applicant/test/[sessionId]/page.tsx:285,287` - test page s sticky headerom
- `app/applicant/test/[sessionId]/result/page.tsx:126` - result page
- `app/applicant/dashboard/page.tsx:407` - dashboard page
- `app/applicant/my-tests/page.tsx:515` - my-tests page

**Výsledok:** Banner sa teraz zobrazuje korektne na všetkých applicant stránkach pri admin switch.

---

## Zmeny v kóde

### Nové súbory
- `app/api/applicant/session/route.ts` - JWT session endpoint
- `app/applicant/layout.tsx` - Layout pre applicant routes
- `app/applicant/dashboard/page.tsx` - Presun z route group

### Presun súborov
```
app/(applicant)/ → app/applicant/
  ├── test/[sessionId]/page.tsx
  ├── test/[sessionId]/result/page.tsx
  ├── my-tests/page.tsx
  ├── login/page.tsx
  └── dashboard/page.tsx
```

### Upravené súbory
- `auth.ts` - Propagácia originalUsername
- `components/SwitchedUserBannerWrapper.tsx` - Použitie originalUsername
- `types/next-auth.d.ts` - Pridanie originalUsername
- 5x applicant API routes - JWT authentication
- 2x applicant frontend pages - Session API usage
- 4x applicant pages - Banner padding fix (pt-16)

---

## Poznámky

- Všetky zmeny boli testované manuálne
- Server beží bez errorov
- Admin switch na uchádzača funguje kompletne
- Tests sú prístupné na správnej URL `/applicant/test/[sessionId]`

---

## Známe problémy

1. **Banner sa stráca pri testoch** - Layout problém, potrebuje riešenie
2. **E2E testy nefungujú** - Potrebuje aktualizácia kvôli zmenám v routing
3. **Komisársky frontend** - Zatiaľ neimplementovaný

---

## Súhrn času

- Celkový čas: ~3 hodiny
- Hlavné úlohy:
  - Routing refactor: 45 min
  - JWT authentication: 60 min
  - Banner fix: 15 min
  - Security deactivation: 20 min
  - Layout fix: 20 min
  - Testing & debugging: 20 min
